import asyncio
import json
import threading
import time

import streamlit as st

from services.config.config import Config
from services.http.client import SyncWebBackendClient
from usecases.kafka.kafka_manager import data_manager, run_kafka_consumer
from services.logger.logger import logger

kafka_thread = None


def init_kafka():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Kafka consumer –æ–¥–∏–Ω —Ä–∞–∑"""
    global kafka_thread
    
    if kafka_thread is None or not kafka_thread.is_alive():
        def run_kafka():
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            try:
                loop.run_until_complete(run_kafka_consumer())
            except Exception as e:
                print(f"Kafka error: {e}")
        
        kafka_thread = threading.Thread(target=run_kafka, daemon=True)
        kafka_thread.start()
        return True
    return False

        
def main():
    st.set_page_config(
        page_title="RecSys31",
        page_icon="üìä",
        layout="wide"
    )
    
    config = Config.from_env()
    web_backend_client = SyncWebBackendClient(config.web_backend)
    
    if 'kafka_init' not in st.session_state:
        if init_kafka():
            st.session_state.kafka_init = True
    
    default_data_raw = """
    {
    "recommendations": [
        {
        "product_name": "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç¬ª",
        "priority": 1,
        "reasoning": "–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (20.8 –¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, 6.33 —Å–æ–±—ã—Ç–∏–π –≤ –¥–µ–Ω—å) –∏ –∏–º–µ–µ—Ç –º—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º 'offers'. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –ø–æ–∫—É–ø–æ–∫, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è —É—Å–ª–æ–≤–∏–µ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏ –ø–æ —ç—Ç–æ–º—É –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–º—É —Å—á–µ—Ç—É.",
        "key_benefits": [
            "–î–æ 17% –≥–æ–¥–æ–≤—ã—Ö, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π –ü–°–ë –¥–ª—è –ø–æ–∫—É–ø–æ–∫.",
            "–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ % –Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫, —á—Ç–æ —É–¥–æ–±–Ω–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
            "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É –∫ 'offers' (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º) –∑–∞ —Å—á–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤—ã–≥–æ–¥—ã."
        ],
        "marketing_strategy": "–ê–∫—Ü–µ–Ω—Ç –Ω–∞ –≤—ã–≥–æ–¥—É –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã: –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Ä–∞—Å—á–µ—Ç–æ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
        "consequences": "–ü–æ–≤—ã—à–µ–Ω–∏–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ —Å—á–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –≤—ã–≥–æ–¥—ã; —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞–≤–∫–∏.",
        "match_score": 0.95
        },
        {
        "product_name": "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª",
        "priority": 2,
        "reasoning": "–ü—Ä–∏ –Ω–∏–∑–∫–∏—Ö –æ–±—â–∏—Ö —Ç—Ä–∞—Ç–∞—Ö (1.28 ‚ÇΩ) –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–∫—É–ø–æ–∫, –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è—Ö —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å–Ω—è—Ç–∏—è. –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –ø–µ—Ä–≤—ã–µ –¥–≤–∞ –º–µ—Å—è—Ü–∞ –º–æ–∂–µ—Ç —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π, –∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö —Ç—Ä–∞—Ç.",
        "key_benefits": [
            "–î–æ 15% –≥–æ–¥–æ–≤—ã—Ö –≤ –ø–µ—Ä–≤—ã–µ 2 –º–µ—Å—è—Ü–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π.",
            "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —á—Ç–æ –¥–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å.",
            "–ú–µ—Ö–∞–Ω–∏–∑–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã."
        ],
        "marketing_strategy": "–ó–∞–ø—É—Å–∫ onboarding-–∫–∞–º–ø–∞–Ω–∏–∏ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ ¬´—Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –ø–æ–¥—É—à–∫—É¬ª: email + –±–∞–Ω–Ω–µ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –∑–∞ 2 –º–µ—Å—è—Ü–∞.",
        "consequences": "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º; —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∫ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–º —Ç—Ä–∞—Ç–∞–º.",
        "match_score": 0.9
        },
        {
        "product_name": "–í–∫–ª–∞–¥ ¬´–ú–æ–π –¥–æ—Ö–æ–¥¬ª",
        "priority": 3,
        "reasoning": "–£—á–∏—Ç—ã–≤–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–∫—É–ø–æ–∫ –∏ –Ω–∏–∑–∫–∏–µ —Ç—Ä–∞—Ç—ã, –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö. '–ú–æ–π –¥–æ—Ö–æ–¥' –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—Å–µ—Ö –∏ –∏–º–µ–µ—Ç –Ω–∞–¥–±–∞–≤–∫—É –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤, –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ —Å–æ—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª–∞—Å—Ç–µ—Ä 18.0 —Å–≤—è–∑–∞–Ω —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –ª—å–≥–æ—Ç–∞–º–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–æ–º. –£—á–∞—Å—Ç–∏–µ –≤ –∞–∫—Ü–∏–∏ '–ë–æ–Ω—É—Å –∑–∞ –≤–∫–ª–∞–¥' –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.",
        "key_benefits": [
            "–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—Å–µ—Ö, —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –±–∞—Ä—å–µ—Ä—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è.",
            "–í–æ–∑–º–æ–∂–Ω–∞ –Ω–∞–¥–±–∞–≤–∫–∞ –¥–æ +1.00% –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤, –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –û–ü–ö/–û–ü–°+.",
            "–£—á–∞—Å—Ç–∏–µ –≤ –∞–∫—Ü–∏–∏ ¬´–ë–æ–Ω—É—Å –∑–∞ –≤–∫–ª–∞–¥¬ª (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ 3000 ‚ÇΩ)."
        ],
        "marketing_strategy": "–¶–µ–ª–µ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ ¬´–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Ö–æ–¥ + –±–æ–Ω—É—Å¬ª —á–µ—Ä–µ–∑ SMS –∏ –±–∞–Ω–Ω–µ—Ä –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –ª—å–≥–æ—Ç–Ω–æ–π –Ω–∞–¥–±–∞–≤–∫–∏.",
        "consequences": "–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–∏—è –∫ –±–∞–Ω–∫—É –∑–∞ —Å—á–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏; –≤–æ–∑–º–æ–∂–Ω–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (–∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–π/–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä).",
        "match_score": 0.85
        },
        {
        "product_name": "–ê–∫—Ü–∏—è ¬´–õ—É—á—à–µ –Ω–æ–ª—å¬ª - –í–µ—Ä–Ω–∏—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É",
        "priority": 4,
        "reasoning": "–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–∫—É–ø–æ–∫, –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º (19 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, 1 –∫–ª–∏–∫). –ê–∫—Ü–∏—è '–õ—É—á—à–µ –Ω–æ–ª—å' –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç, –Ω–æ —Ö–æ—á–µ—Ç –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã. –í–æ–∑–º–æ–∂–Ω–æ, –∫–ª–∏–µ–Ω—Ç –∏–∑—É—á–∞–ª –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∏ —ç—Ç–∞ –∞–∫—Ü–∏—è –º–æ–∂–µ—Ç —Å–Ω—è—Ç—å –æ–ø–∞—Å–µ–Ω–∏—è –ø–æ –ø–æ–≤–æ–¥—É –ø–µ—Ä–µ–ø–ª–∞—Ç—ã.",
        "key_benefits": [
            "–í–æ–∑–≤—Ä–∞—Ç –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–µ–¥–∏—Ç—É –±–∞–ª–ª–∞–º–∏, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π –≤—ã–≥–æ–¥–æ–π.",
            "–°–Ω–∏–∂–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø–æ–≥–∞—à–µ–Ω–∏–∏.",
            "–ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∑–∞–µ–º–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞."
        ],
        "marketing_strategy": "–†–µ—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: push —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º ¬´–ú—ã –≤–µ—Ä–Ω—ë–º –≤–∞–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ–ª–æ –∫—Ä–µ–¥–∏—Ç–∞¬ª.",
        "consequences": "–°–Ω–∏–∂–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ–º–æ–≥–æ —Ä–∏—Å–∫–∞ –ø–æ –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—é; —Ä–æ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞.",
        "match_score": 0.75
        },
        {
        "product_name": "–ö–µ—à–±—ç–∫ –∏ —Å–∫–∏–¥–∫–∏ –æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–¢–µ—Ö–Ω–∏–∫–∞)",
        "priority": 5,
        "reasoning": "–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ - 'Electronic Devices and Gadgets'. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∫–µ—à–±—ç–∫—É –Ω–∞ —Ç–µ—Ö–Ω–∏–∫—É (multinel, ReadySkin, Rokodil, galaxystore, –ë–∏–ª–∞–π–Ω, Restore, Krona, –ú–µ–≥–∞–§–æ–Ω) –Ω–∞–ø—Ä—è–º—É—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º, –¥–∞–∂–µ –ø—Ä–∏ –Ω–∏–∑–∫–∏—Ö —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞—Ç–∞—Ö. –≠—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –±—É–¥—É—â–∏–µ –ø–æ–∫—É–ø–∫–∏.",
        "key_benefits": [
            "–ü—Ä—è–º–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –∫–ª–∏–µ–Ω—Ç–∞ ('Electronic Devices and Gadgets').",
            "–ö–µ—à–±—ç–∫ –¥–æ 10% –Ω–∞ –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏.",
            "–ú–æ–∂–µ—Ç —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫ –≤ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."
        ],
        "marketing_strategy": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç —Å –ø–æ–¥–±–æ—Ä–∫–æ–π –∞–∫—Ü–∏–π –æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–µ—à–±—ç–∫–∞ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫.",
        "consequences": "–°—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏; —É—Å–∏–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –±–∞–Ω–∫–∞ —á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.",
        "match_score": 0.7
        }
    ],
    "summary": "–ö–ª–∏–µ–Ω—Ç —Å ID 25770580 –ø—Ä–æ—è–≤–ª—è–µ—Ç —É–º–µ—Ä–µ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∏–∑—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –ø–æ–∫–∞ –Ω–µ —Å–æ–≤–µ—Ä—à–∞–ª –ø–æ–∫—É–ø–æ–∫. –ï–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–µ—Å —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω –Ω–∞ 'Electronic Devices and Gadgets'. –†–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞ –∫–∞–∫ —Å–ø–æ—Å–æ–± –Ω–∞—á–∞—Ç—å —Å–±–µ—Ä–µ–≥–∞—Ç—å –ø—Ä–∏ –Ω–∏–∑–∫–∏—Ö —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞—Ç–∞—Ö, –∞ —Ç–∞–∫–∂–µ –∞–∫—Ü–∏–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º –∏ –∫–µ—à–±—ç–∫-–ø—Ä–æ–≥—Ä–∞–º–º—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –≤ —Ç–µ—Ö–Ω–∏–∫–µ, —á—Ç–æ–±—ã —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–∞–Ω–∫–æ–º."
    }
    """

    # default_data = json.loads(default_data_raw)
    
    # recommendations = json.loads(data)["recommendations"]
    # summary = json.loads(data)["summary"]
    
    col1, col2 = st.columns([0.2, 0.8])
    with col1:
        st.image(
            "assets/PSB_logo_white.png",
            width=800,
        )
    with col2:
        st.title("RecSys31")

    with st.form("my_form"):
        user_id = st.text_input("–í–≤–µ–¥–∏—Ç–µ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:")
        submitted = st.form_submit_button("–û—Ç–ø—Ä–∞–≤–∏—Ç—å")
        if submitted and user_id:
            web_backend_client.send_recommendation_request(user_id)
            st.success(f"–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")

    current_message = data_manager.get_latest_message()
    
    if current_message:
        try:
            recommendations_data = current_message.get("recommendations", [])
            summary = current_message.get("summary", "")
            
            # Handle nested structure: recommendations might be a dict with 'recommendations' and 'summary' keys
            if isinstance(recommendations_data, dict):
                # Extract the actual recommendations list and summary if nested
                recommendations = recommendations_data.get("recommendations", [])
                if not summary and "summary" in recommendations_data:
                    summary = recommendations_data.get("summary", "")
            else:
                recommendations = recommendations_data
            
            st.success("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Kafka")
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
            recommendations = []
            summary = ""
    else:
        recommendations = []
        summary = ""
    
    if st.button("–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"):
        st.rerun()
        
    st.header("–û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞:")
    st.info(summary)

    st.header("–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:")

    logger.info(f'GET RECS: {recommendations}')
    # sorted_recommendations = sorted(recommendations, key=lambda x: x["priority"])

    # Ensure recommendations is a list
    if not isinstance(recommendations, list):
        recommendations = []
    
    recommendations_list = recommendations

    for rec in recommendations_list:
        # logger.info(rec_raw)
        # rec = json.loads(rec_raw)
        with st.container():
            col1, col2 = st.columns([4, 1])
            with col1:
                st.subheader(f"{rec['priority']}. {rec['product_name']}")
            with col2:
                st.metric("Match Score", f"{rec['match_score']*100}%")

            st.write(f"**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** {rec['reasoning']}")

            st.write("**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**")
            for benefit in rec["key_benefits"]:
                st.write(f"‚Ä¢ {benefit}")

            with st.expander("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è"):
                st.write(rec["marketing_strategy"])

            with st.expander("–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç"):
                st.write(rec["consequences"])

            st.markdown("---")
    
    

if __name__ == "__main__":
    main()
